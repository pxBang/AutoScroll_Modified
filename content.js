let isScrolling=!1,scrollMode="continuous",scrollSpeed=4,scrollDistance=500,scrollInterval=2e3,showFloatButton=!0,floatButton=null,scrollTimer=null,lastScrollPosition=0,scrollStuckCount=0,scrollableElement=null,scrollAccumulator=0,amplitudeInstance=null;function initAmplitude(){try{let t=document.createElement("script");t.src=chrome.runtime.getURL("lib/amplitude.umd.min.js"),t.onload=function(){void 0!==window.amplitude&&chrome.storage.local.get("my_user_id",t=>{let e=t.my_user_id;e&&(amplitudeInstance=window.amplitude.getInstance()).init("ac9c2f8739b8ebf09da5c0786e2ba579",e,{defaultTracking:!0})})},document.head.appendChild(t)}catch(e){console.error("Ошибка при инициализации Amplitude:",e)}}function logAmplitudeEvent(t,e){try{amplitudeInstance?amplitudeInstance.logEvent(t,e):void 0!==window.amplitude&&window.amplitude.getInstance().logEvent(t,e)}catch(o){console.error("Ошибка при отправке события в Amplitude:",o)}}initAmplitude();const dragStyleElement=document.createElement("style");function getActualScrollSpeed(t){return 20===t?30:1===t?.25:2===t?.5:3===t?.75:t-2}function determineScrollableElement(){return window}function canScrollStandard(){let t=window.scrollY;window.scrollBy({top:1,behavior:"auto"});let e=window.scrollY>t;return e&&window.scrollBy({top:-1,behavior:"auto"}),e}function findBestScrollableElement(){if("docs.google.com"===window.location.hostname){let t=document.querySelector(".kix-appview-editor");if(t){let e=t.querySelector(".kix-appview-editor-container");if(e)return e}}let o=document.querySelectorAll("*"),l=null,n=0,r=window.innerWidth,s=window.innerHeight;for(let i of o){if(i===document.body||i===document.documentElement)continue;let a=getComputedStyle(i);if("auto"!==a.overflowY&&"scroll"!==a.overflowY||i.scrollHeight<=i.clientHeight)continue;let c=i.getBoundingClientRect();if(c.top>=s||c.bottom<=0||c.left>=r||c.right<=0)continue;let u=Math.max(0,c.top),d=Math.min(s,c.bottom),p=Math.max(0,c.left),m=Math.min(r,c.right);if(d<=u||m<=p)continue;let g=m-p,$=d-u,f=g*$,v=f*(g/r);v>n&&(n=v,l=i)}return l||window}function updateFloatButtonVisibility(){if(!floatButton&&showFloatButton){createFloatButton();return}floatButton&&(floatButton.style.display=showFloatButton?"flex":"none")}function startScrolling(){if(isScrolling)return;isScrolling=!0;let t=canScrollStandard();if(lastScrollPosition=(scrollableElement=t?window:findBestScrollableElement())===window?window.scrollY:scrollableElement.scrollTop,scrollStuckCount=0,scrollAccumulator=0,createFloatButton(),"continuous"===scrollMode){let e=()=>{if(!isScrolling)return;let o=scrollableElement===window?window.scrollY:scrollableElement.scrollTop;if(o===lastScrollPosition){if(++scrollStuckCount>5){if(scrollableElement===window&&!t&&(scrollableElement=findBestScrollableElement())!==window){lastScrollPosition=scrollableElement.scrollTop,scrollStuckCount=0,scrollTimer=requestAnimationFrame(e);return}setTimeout(()=>{let t=scrollableElement===window?window.scrollY:scrollableElement.scrollTop;t===lastScrollPosition&&isScrolling&&(scrollableElement===window?window.scrollBy({top:10,behavior:"auto"}):scrollableElement.scrollTop+=10),scrollStuckCount=0},1e3)}}else scrollStuckCount=0,lastScrollPosition=o;let l=getActualScrollSpeed(scrollSpeed);if(l<1){if((scrollAccumulator+=l)>=1){let n=Math.floor(scrollAccumulator);scrollAccumulator-=n,scrollableElement===window?window.scrollBy({top:n,behavior:"auto"}):scrollableElement.scrollTop+=n}}else scrollableElement===window?window.scrollBy({top:l,behavior:"auto"}):scrollableElement.scrollTop+=l;scrollTimer=requestAnimationFrame(e)};scrollTimer=requestAnimationFrame(e)}else scrollTimer=setInterval(()=>{if(!isScrolling)return;let e=scrollableElement===window?window.scrollY:scrollableElement.scrollTop;if(e===lastScrollPosition){if(++scrollStuckCount>3){if(scrollableElement===window&&!t&&(scrollableElement=findBestScrollableElement())!==window){lastScrollPosition=scrollableElement.scrollTop,scrollStuckCount=0;return}scrollStuckCount=0;return}}else scrollStuckCount=0;if(lastScrollPosition=e,scrollableElement===window)window.scrollBy({top:scrollDistance,behavior:"smooth"});else{let o=scrollableElement.scrollTop+scrollDistance;((t,e)=>{let l=scrollableElement.scrollTop,n=o-l,r=s=>{if(!isScrolling)return;let i=s-t;if(i>=e){scrollableElement.scrollTop=o;return}let a=i/e;scrollableElement.scrollTop=l+n*(a<.5?2*a*a:1-Math.pow(-2*a+2,2)/2),requestAnimationFrame(r)};requestAnimationFrame(r)})(performance.now(),300)}},scrollInterval);updateFloatButtonState()}function stopScrolling(){isScrolling=!1,"continuous"===scrollMode?cancelAnimationFrame(scrollTimer):clearInterval(scrollTimer),updateFloatButtonState()}function createFloatButton(){try{if(floatButton){floatButton.style.display=showFloatButton?"flex":"none",ensureButtonVisibility();return}function t(t){(t.target===floatButton||floatButton.contains(t.target))&&(console.error("AutoScroll: Ошибка при взаимодействии с кнопкой:",t.error),t.error&&t.error.message&&t.error.message.includes("Extension context invalidated")&&cleanupOnError(),t.stopPropagation(),t.preventDefault())}(floatButton=document.createElement("div")).id="autoscroll-float-button",floatButton.style.cssText=`
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-color: rgba(26, 115, 232, 0.95);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
      z-index: 2147483647; /* Максимально возможное значение z-index */
      transition: all 0.2s ease;
      touch-action: none; /* Предотвращает обработку касаний браузером */
      user-select: none; /* Предотвращает выделение текста */
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      visibility: visible !important; /* Принудительно делаем видимым */
      opacity: 1 !important; /* Принудительно устанавливаем полную непрозрачность */
      transform: none !important; /* Предотвращаем трансформации, которые могут скрыть элемент */
      pointer-events: auto !important; /* Гарантируем, что элемент получает события мыши */
      will-change: transform; /* Оптимизация производительности анимаций */
      mix-blend-mode: normal; /* Гарантируем нормальный режим смешивания с фоном */
      filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.5)); /* Тень для лучшей видимости */
      backdrop-filter: none; /* Предотвращаем изменение фона под кнопкой */
      clip-path: none !important; /* Предотвращаем обрезание кнопки */
      mask: none !important; /* Предотвращаем маскирование */
    `,floatButton.innerHTML=isScrolling?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>':'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg>',ensureButtonVisibility(),floatButton.style.display=showFloatButton?"flex":"none",window.addEventListener("error",t,!0),window.autoscrollErrorHandler=t;try{makeDraggable(floatButton)}catch(e){if(console.error("AutoScroll: Ошибка при настройке перетаскивания:",e),e.message&&e.message.includes("Extension context invalidated")){cleanupOnError();return}}try{loadButtonPosition()}catch(o){console.error("AutoScroll: Ошибка при загрузке позиции кнопки:",o),o.message&&o.message.includes("Extension context invalidated")&&cleanupOnError()}}catch(l){console.error("AutoScroll: Ошибка при создании плавающей кнопки:",l),l.message&&l.message.includes("Extension context invalidated")&&cleanupOnError()}}function updateFloatButtonState(){floatButton&&(floatButton.innerHTML=isScrolling?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>':'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg>')}function initializeExtension(){try{chrome.storage.sync.get("settings",t=>{t.settings&&(scrollMode=t.settings.mode||"continuous",scrollSpeed=isNaN(parseInt(t.settings.speed))?3:parseInt(t.settings.speed),scrollDistance=20*parseInt(t.settings.distance)||40,scrollInterval=1e3*parseInt(t.settings.interval)||2e3,showFloatButton=void 0===t.settings.showFloatButton||t.settings.showFloatButton),showFloatButton&&createFloatButton()})}catch(t){console.error("AutoScroll: Ошибка при инициализации расширения:",t),scrollMode="continuous",scrollSpeed=3,scrollDistance=40,scrollInterval=2e3,showFloatButton=!0;try{createFloatButton()}catch(e){console.error("AutoScroll: Не удалось создать кнопку:",e)}}}if(dragStyleElement.textContent=`
  body.autoscroll-dragging {
    user-select: none !important;
    -webkit-user-select: none !important;
    -moz-user-select: none !important;
    -ms-user-select: none !important;
    cursor: grabbing !important;
  }
  body.autoscroll-dragging * {
    user-select: none !important;
    -webkit-user-select: none !important;
    -moz-user-select: none !important;
    -ms-user-select: none !important;
  }
`,document.head.appendChild(dragStyleElement),chrome.runtime.onMessage.addListener((t,e,o)=>{switch(t.action){case"startScroll":scrollMode=t.mode,scrollSpeed=isNaN(t.speed)?3:t.speed,scrollDistance=t.distance,scrollInterval=t.interval,showFloatButton=t.showFloatButton,startScrolling(),o({success:!0});break;case"stopScroll":stopScrolling(),o({success:!0});break;case"getStatus":o({isScrolling:isScrolling});break;case"updateFloatButton":showFloatButton=t.showFloatButton,updateFloatButtonVisibility(),o({success:!0});break;case"updateSettings":scrollSpeed=isNaN(t.speed)?3:t.speed,scrollDistance=t.distance,scrollInterval=t.interval,o({success:!0})}return!0}),document.addEventListener("DOMContentLoaded",function(){try{initializeExtension()}catch(t){console.error("AutoScroll: Ошибка при инициализации расширения:",t)}}),"complete"===document.readyState||"interactive"===document.readyState)try{initializeExtension()}catch(t){console.error("AutoScroll: Ошибка при инициализации расширения:",t)}function saveButtonPosition(t,e){try{chrome.storage.sync.set({buttonPosition:{left:t,top:e}})}catch(o){console.error("AutoScroll: Ошибка сохранения позиции:",o),cleanupOnError()}}function loadButtonPosition(){try{chrome.storage.sync.get("buttonPosition",t=>{if(t.buttonPosition&&floatButton){let{left:e,top:o}=t.buttonPosition;void 0!==e&&void 0!==o&&(floatButton.style.left=e+"px",floatButton.style.right="auto",floatButton.style.top=o+"px",floatButton.style.bottom="auto")}})}catch(t){console.error("AutoScroll: Ошибка загрузки позиции:",t),cleanupOnError()}}function cleanupOnError(){floatButton&&floatButton.parentNode&&floatButton.parentNode.removeChild(floatButton),floatButton=null,isScrolling=!1,window.removeEventListener("mousemove",window.autoscrollDragMove),window.removeEventListener("mouseup",window.autoscrollDragEnd),window.removeEventListener("touchmove",window.autoscrollDragMove),window.removeEventListener("touchend",window.autoscrollDragEnd),window.autoscrollErrorHandler&&window.removeEventListener("error",window.autoscrollErrorHandler,!0),window.autoscrollCheckIntervalId&&clearInterval(window.autoscrollCheckIntervalId),window.autoscrollMutationObserver&&window.autoscrollMutationObserver.disconnect(),window.autoscrollDragMove=null,window.autoscrollDragEnd=null,window.autoscrollErrorHandler=null,window.autoscrollCheckIntervalId=null,window.autoscrollMutationObserver=null}function makeDraggable(t){let e=!1,o=!1,l,n,r,s,i=0,a=0,c=0,u=null,d=t.getBoundingClientRect();r=d.left,s=d.top,i=r,a=s;let p=d=>{u&&(clearTimeout(u),u=null),c=Date.now(),o=!1,d.stopPropagation(),"touchstart"!==d.type&&d.preventDefault();let p=t.getBoundingClientRect();r=p.left,s=p.top,i=r,a=s,"touchstart"===d.type?(l=d.touches[0].clientX-i,n=d.touches[0].clientY-a):(l=d.clientX-i,n=d.clientY-a),e=!0,document.body.classList.add("autoscroll-dragging")},m=c=>{if(!e)return;c.preventDefault();let u,d;"touchmove"===c.type?(u=c.touches[0].clientX,d=c.touches[0].clientY):(u=c.clientX,d=c.clientY);let p=u-l,m=d-n;!o&&(Math.abs(p-r)>5||Math.abs(m-s)>5)&&(o=!0),r=p,s=m;let g=window.innerWidth,$=window.innerHeight;r=Math.max(0,Math.min(r,g-48)),s=Math.max(0,Math.min(s,$-48)),i=r,a=s,t.style.right="auto",t.style.bottom="auto",t.style.left=r+"px",t.style.top=s+"px"},g=t=>{if(!e)return;document.body.style.userSelect="";let i=Date.now(),a=i-c;try{saveButtonPosition(r,s)}catch(d){console.error("AutoScroll: Ошибка сохранения позиции при завершении перетаскивания:",d),cleanupOnError();return}l=r,n=s,e=!1,!o&&a<300&&(u=setTimeout(()=>{$()},50)),document.body.classList.remove("autoscroll-dragging")},$=()=>{try{try{let t=window.location.hostname;chrome.storage.local.get("my_user_id",e=>{let o=e.my_user_id;o&&logAmplitudeEvent("FLOAT_BUTTON_CLICK",{isStartingScroll:!isScrolling,domain:t})})}catch(e){console.error("Ошибка при отправке аналитики:",e)}isScrolling?stopScrolling():chrome.storage.sync.get("settings",t=>{t.settings?(scrollMode=t.settings.mode||"continuous",scrollSpeed=parseInt(t.settings.speed),isNaN(scrollSpeed)&&(scrollSpeed=3),scrollDistance=20*parseInt(t.settings.distance)||40,scrollInterval=1e3*parseInt(t.settings.interval)||2e3,startScrolling()):(scrollMode="continuous",scrollSpeed=3,scrollDistance=40,scrollInterval=2e3,startScrolling())})}catch(o){console.error("AutoScroll: Ошибка при обработке клика:",o),cleanupOnError()}};window.autoscrollDragMove=m,window.autoscrollDragEnd=g,t.addEventListener("mousedown",p,!1),window.addEventListener("mousemove",m,!1),window.addEventListener("mouseup",g,!1),t.addEventListener("touchstart",p,{passive:!1}),window.addEventListener("touchmove",m,{passive:!1}),window.addEventListener("touchend",g,{passive:!1}),t.removeEventListener("click",t.clickHandler),t.clickHandler=$}function setupButtonPresenceCheck(){let t=setInterval(()=>{try{!showFloatButton||floatButton&&document.body.contains(floatButton)?floatButton&&ensureButtonVisibility():(floatButton=null,createFloatButton())}catch(e){console.error("AutoScroll: Ошибка при проверке наличия кнопки:",e),e.message&&e.message.includes("Extension context invalidated")&&(clearInterval(t),cleanupOnError())}},2e3);window.autoscrollCheckIntervalId=t}function ensureButtonVisibility(){if(!floatButton)return;let t=document.getElementById("autoscroll-top-level-container");t||((t=document.createElement("div")).id="autoscroll-top-level-container",t.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 2147483647;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      transform: none !important;
    `,document.body.appendChild(t)),floatButton.style.zIndex="2147483647",floatButton.style.visibility="visible",floatButton.style.opacity="1",floatButton.style.display=showFloatButton?"flex":"none",floatButton.parentNode!==t&&t.appendChild(floatButton),t.parentNode!==document.body&&document.body.appendChild(t)}function setupMutationObserver(){try{let t=new MutationObserver(e=>{try{showFloatButton&&floatButton&&!document.body.contains(floatButton)?(floatButton=null,createFloatButton()):showFloatButton&&floatButton&&ensureButtonVisibility()}catch(o){console.error("AutoScroll: Ошибка в MutationObserver:",o),o.message&&o.message.includes("Extension context invalidated")&&(t.disconnect(),cleanupOnError())}});t.observe(document.documentElement,{childList:!0,subtree:!0}),window.autoscrollMutationObserver=t}catch(e){console.error("AutoScroll: Ошибка при настройке MutationObserver:",e)}}window.addEventListener("error",function(t){if(t.error&&t.error.message&&t.error.message.includes("Extension context invalidated"))return console.error("AutoScroll: Контекст расширения недействителен, очистка ресурсов:",t.error),cleanupOnError(),t.preventDefault(),!1},!0),window.addEventListener("popstate",function(){setTimeout(function(){try{showFloatButton&&!floatButton?createFloatButton():floatButton&&updateFloatButtonVisibility()}catch(t){console.error("AutoScroll: Ошибка при обработке изменения истории:",t),t.message&&t.message.includes("Extension context invalidated")&&cleanupOnError()}},300)}),setupButtonPresenceCheck(),"complete"===document.readyState||"interactive"===document.readyState?setupMutationObserver():document.addEventListener("DOMContentLoaded",setupMutationObserver);